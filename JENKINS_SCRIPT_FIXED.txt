#!/bin/bash
# Jenkins Execute Shell ìŠ¤í¬ë¦½íŠ¸ (403 ì˜¤ë¥˜ ìˆ˜ì • ë²„ì „)
# ì´ ë‚´ìš©ì„ Jenkinsì— ë³µì‚¬í•´ì„œ ì‚¬ìš©í•˜ì„¸ìš”

set -euo pipefail

PORT=7008
echo "=== dabang-movers-app ìë™ ë°°í¬ ì‹œì‘ (PORT: ${PORT}) ==="

# ì‘ì—… ë””ë ‰í† ë¦¬ í™•ì¸
echo "í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
echo "íŒŒì¼ ëª©ë¡:"
ls -la

# 1) ì˜ì¡´ì„± ì„¤ì¹˜
echo "1. ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
npm ci --prefer-offline --no-audit --progress=false || npm install

# 2) Next.js ë¹Œë“œ
echo "2. Next.js ë¹Œë“œ ì¤‘..."
npm run build

# ë¹Œë“œ ê²°ê³¼ í™•ì¸
if [ -d ".next" ]; then
  echo "âœ… .next ë””ë ‰í† ë¦¬ ìƒì„± í™•ì¸"
else
  echo "âŒ .next ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ë¹Œë“œ ì‹¤íŒ¨!"
  exit 1
fi

# 3) ì´ì „ ì„œë²„ ì¢…ë£Œ
echo "3. ê¸°ì¡´ ì„œë²„ ì¢…ë£Œ ì¤‘..."
if [ -f server.pid ]; then
  OLD_PID="$(cat server.pid || true)"
  if [ -n "${OLD_PID:-}" ] && ps -p "$OLD_PID" >/dev/null 2>&1; then
    echo "ê¸°ì¡´ ì„œë²„ ì¢…ë£Œ (PID: $OLD_PID)"
    kill -9 "$OLD_PID" || true
    sleep 2
  fi
fi
# ëª¨ë“  Node.js/Next.js í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
pkill -f "node.*server.js" || true
pkill -f "next start" || true
pkill -f "node.*next" || true
sleep 2

# 4) Custom Serverë¡œ ì‹¤í–‰ (server.js ì‚¬ìš©)
echo "4. Next.js Custom Server ì‹œì‘..."
PORT=${PORT} NODE_ENV=production nohup node server.js > server.log 2>&1 &
PID=$!
echo $PID > server.pid
echo "ì„œë²„ PID: $PID"

# 5) ì„œë²„ ì‹œì‘ ëŒ€ê¸°
echo "5. ì„œë²„ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
sleep 5

# 6) í—¬ìŠ¤ì²´í¬
echo "6. ì„œë²„ ìƒíƒœ í™•ì¸..."
SUCCESS=false
for i in $(seq 1 30); do
  # ë‚´ë¶€ ì ‘ì† í…ŒìŠ¤íŠ¸
  if curl -fsS "http://localhost:${PORT}" >/dev/null 2>&1; then
    echo "âœ… localhost:${PORT} ì ‘ì† ì„±ê³µ"
    SUCCESS=true
    break
  fi
  echo "ëŒ€ê¸°ì¤‘... ($i/30)"
  sleep 2
done

if [ "$SUCCESS" = false ]; then
  echo "âŒ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨"
  echo "=== ì„œë²„ ë¡œê·¸ ==="
  cat server.log || true
  echo "=== í”„ë¡œì„¸ìŠ¤ í™•ì¸ ==="
  ps aux | grep -E "node|next" | grep -v grep || true
  exit 1
fi

# 7) ìµœì¢… í™•ì¸
echo ""
echo "========================================="
echo "âœ… ë°°í¬ ì™„ë£Œ!"
echo "========================================="
echo "ğŸ“Œ ë‚´ë¶€ ì ‘ì†: http://localhost:${PORT}"
echo "ğŸ“Œ ì™¸ë¶€ ì ‘ì†: http://192.168.0.109:${PORT}"
echo "========================================="
echo ""

# ì„œë²„ ë¡œê·¸ ì¶œë ¥ (ë§ˆì§€ë§‰ 20ì¤„)
echo "=== ì„œë²„ ë¡œê·¸ (ìµœê·¼ 20ì¤„) ==="
tail -n 20 server.log || true

# í”„ë¡œì„¸ìŠ¤ í™•ì¸
echo ""
echo "=== ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ ==="
ps aux | grep -E "node.*server.js" | grep -v grep || true

exit 0